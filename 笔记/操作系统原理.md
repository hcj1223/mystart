# 操作系统原理

## 一、操作系统概述

### 1.操作系统的层次结构：（由内到外）裸机-CPU调度-内存管理-设备管理-文件管理-作业管理-命令管理-用户

### 2.操作系统管理的四大资源：处理机、存储器、设备、文件

### 3.操作系统的四大功能：处理机管理、存储器管理、设备管理、文件管理

### 4.<font color=red>操作系统的四大特征：并发、共享、虚拟、异步</font>

### 5.分时系统（P9）、实时系统（P11）、批处理（P6）、多道程序设计技术（P8）

### 6.操作系统的作用

#### （1）作为用户与计算机硬件系统之间的接口

#### （2）作为计算机系统资源的管理者

#### （3）对计算机资源实现抽象

## 二、进程管理

### 1.进程：描述程序执行时的动态特征，由程序段、数据段和进程控制块组成

#### （1）顺序执行特征：封闭性、可再现性

#### （2）并发执行特征：间断性、失去封闭性、不可再现性

#### （3）进程特征：动态性、并发性、独立性、异步性

### 2.进程控制块PCB

#### （1）PCB中的信息：进程标识符；处理机状态；进程调度信息；进程控制信息

#### （2）<font color=red>组织方式</font>（P45）：线性；链接；索引

### 3.<font color=red>进程的基本状态和状态转换</font>（P41）

### 4.进程控制

#### （1）进程的创建：申请空白PCB；为新进程分配运行所需资源；初始化进程控制块；将新进程插入就绪队列

#### （2）进程的阻塞：向系统请求共享资源失败；等待某种操作完成；新数据尚未到达；等待新任务到达

#### （3）原语：执行过程中不可中断

### 5.进程同步

#### （1）<font color=red>同步关系</font>

##### 1...间接相互制约关系（竞争）：多个进程互斥地访问临界资源

##### 2...直接相互制约关系（合作）：多个进程同步完成同一项任务

##### 3...互斥是同步的一种特殊情况

#### （2）<font color=red>遵循准则</font>：空闲让进；忙则等待；有限等待；让权等待

#### （3）实现同步的软件方法（PIC1-9）：强制轮换法；锁变量方法；先修改、后检查、后修改者等待（正确）

```c++
//两个进程p0，p1同步
bool flag[2] = {0, 0};
int turn;
while(1)
{
    flag[0] = 1;
    turn = 1; //描述可进入的进程
    while(flag[1] && turn ==1);
    临界区
    flag[0] = 0;
    剩余区
}
```

#### （4）实现同步的硬件方法：关中断、Test-and-Set指令和Swap指令（P56）

#### （5）临界资源：在一段时间内只允许一个进程访问该资源；临界区：访问临界资源的代码；进入区、临界区、退出区、剩余区

#### （6）信号量机制：整型信号量；记录型信号量；AND型信号量（P59）；信号量集；信号量的应用（P61）

```c++
// P、V操作
wait(S)
{
    while(S <= 0)；
    S--;
}
signal(S)
{
    S++;
}
```

#### （7）简单同步应用问题：司机-售票员问题（PIC10、11）

#### （8）<font color=red>经典进程同步问题</font>：生产者-消费者问题（P65）及变形（PIC12-22）；读者-写者问题（P70）及实例（PIC23-25）；哲学家进餐问题（P69）及死锁解决（PIC26-27）

### 6.<font color=red>“饥饿”现象及原因</font>：资源分配不公平导致在一个可以预见的时间内一个或多个进程得不到满足，如都不能访问临界资源

### 7.进程通信

#### （1）低级通信和高级通信（P73）

#### （2）高级通信三种类型：管道通信（P74）及实例（PIC28-32）；消息传递通信（P74）及实例（PIC33-34）；共享存储区（P73）

<img src="../AppData/Roaming/Typora/typora-user-images/image-20230609100322250.png" alt="image-20230609100322250" style="zoom: 50%;" />

### 8.<font color=red>死锁</font>：指多个进程因竞争资源而造成的一种僵局，若无外力作用，这些进程都将永远不能再向前推进（P112）及例题（PIC35）

#### （1）发生原因：竞争资源；进程推进顺序非法

##### 1...竞争不可抢占型资源：双方都拥有部分资源，同时在请求对方已占有的资源

##### 2...竞争临时性资源：双方都等待对方去生成资源

##### 3...进程推进顺序不当（P115图3-14）

#### （2）资源分类：可抢占型，如CPU、内存；不可抢占型，如打印机；永久型，如打印机；临时型，如硬件中断、消息

#### （3）<font color=red>死锁发生的条件：互斥；请求和等待；不可抢占；环路等待（P116）</font>

#### （4）<font color=red>处理死锁的方法：预防；避免；检测；解除（P116）</font>

##### 1...预防：破坏“请求和等待”条件（P117）；破坏“不可抢占”条件（P117）；破坏“环路等待”条件（P118）---系统按照特定资源分配策略给进程分配资源

##### 2...避免：对进程发出的资源申请进行动态检查，若分配后系统可能发生死锁，则不予分配，否则予以分配

##### 3...检测：利用某种算法对这些信息加以检查，以判断是否存在死锁（P123）

#### （5）<font color=red>银行家算法</font>及样例（P120）

### 9.处理机调度

#### （1）层次：高级、低级、中级（P92）

#### （2）常用指标：周转时间；响应时间；截止时间；优先权；吞吐量；处理机利用率（P94）

#### （3）<font color=red>调度算法</font>：先来先服务FCFS（P96）；短作业优先SJF（P97）；优先级调度算法HPF（P102）；高响应比优先HRNN：优先级Rp=(等待时间+服务时间)/服务时间（P98）；轮转调度算法RR（P100）；多级反馈调度算法FB（P103）

### 10.实时调度

#### （1）任务类型：（非）周期性实时任务；硬实时任务HRT；软实时任务SRT（P105）

#### （2）实时调度算法：最早截止时间优先EDF（P107）；最低松弛度优先LLF（P109）：松弛度=必须完成时间-进程运行时间-当前时间

#### （3）优先级倒置（P110）及解决方法（P117）

## 三、存储管理

### 1.连续分配存储管理方式：单一连续（P135）；固定分区（P136）；动态分区（P137）；可重定位分区（P142）：“紧凑"

#### （1）动态分区分配

##### 1...数据结构：空闲分区表；空闲分区链（P137）

##### 2...<font color=red>基于顺序搜索的动态分区分配算法</font>：首次适应FF；循环首次适应NF；最佳适应BF；最坏适应WF（P140）/ 基于索引搜索的动态分区分配算法：快速适应算法（P141）；伙伴系统（P141）；哈希算法（P144）

#### （2）”紧凑“：将内存中所有作业移动，使它们全部相邻接

#### （3）内碎片：多分配出的空间；外碎片：太小而无法分配的空间

### 2.离散分配存储管理方式（PIC38-39）

#### （1）<font color=red>分页</font>（P148）：

##### 1...地址结构：页号+页内地址

##### 2...页表：页号+块号

##### 3...地址变换（P150）及例题（PIC36） 

##### 4...快表TLB（P151）及例题（PIC37）

##### 5...两级页表（P152）；反置页表（P154）

#### （2）分段（P156）

##### 1...地址结构：段号+段内地址

##### 2...段表：段号+段长+基址

##### 3...地址变换（P158）

#### （3）段页式（P160）

##### 1...地址结构：段号+段内页号+页内地址

##### 2...地址变换（P162）

##### 3...需三次访问内存：访问段表；访问页表；取数据

### 3.虚拟存储

#### （1）局部性原理（P165）

#### （2）虚拟存储器概念：具有请求调入和置换（P165）功能，能从逻辑上对内存扩充的一种存储器系统

#### （3）对换/置换技术

##### 1...类型：整体对换；页面（分段）对换

##### 2...功能：对换空间的管理；进程的换出换入

##### 3...把磁盘分为文件区和对换区，文件区的空间管理采用离散分配，对换区采用连续分配

#### （4）实现方式：

##### 1...请求分页：请求页表机制（P168）；内存分配策略：固定分配局部置换，可变分配局部置换，可变分配全局置换；页面调入策略（P172）；<font color=red>页面置换算法</font>（最佳OPT：P175；先进先出FIFO：P175；最近最久未使用LRU：P176；最近未使用Clock/NRU：P178、PIC42-43；最少使用LFU：P177）

###### 页面调入过程：程序发生缺页时，向CPU发出缺页中断了，保护CPU环境-分析中断原因-转入中断处理程序进行处理-恢复CPU环境。如果内存未满，则启动磁盘I/O，将所缺页调入内存，修改页表。如果内存已满，则通过置换算法从内存中选出一页换出，如果该页未被修改，则不必写回磁盘，然后将所缺页调入内存，修改页表和快表。

###### LRU和LFU硬件支持：移位寄存器

##### 2...请求分段：请求段表机制（P185）

#### （5）缺页率 = 缺页次数 / 总的页面访问次数

##### 1...<font color=red>影响缺页率的因素</font>：页面大小；进程所分配的物理块数目；页面置换算法；程序固有特性

##### 2...缺页中断：保护CPU环境-分析中断原因-转入中断处理程序进行处理-恢复CPU环境

#### （6）<font color=red>访问内存的有效时间（PIC45；P180）</font>

#### （7）“抖动”现象的原因：刚被换出的页很快又被访问并重新调入，此时选出一页调出；被调出页又很快被访问并被调入，造成进程大部分时间用于页面换进换出

## 四、文件系统

### 1.文件系统的层次结构（P240）

### 2.<font color=red>文件的逻辑结构</font>：有/无结构文件（P243）；顺序文件（P244）；索引文件（P246）；索引顺序文件（P247）；直接文件、哈希文件（P248）

### 3.文件的存取方法

<img src="./../AppData/Roaming/Typora/typora-user-images/image-20230611200054415.png" alt="image-20230611200054415" style="zoom: 50%;" />

<img src="./../AppData/Roaming/Typora/typora-user-images/image-20230611200642730.png" alt="image-20230611200642730" style="zoom: 50%;" />

<img src="./../AppData/Roaming/Typora/typora-user-images/image-20230611200915566.png" alt="image-20230611200915566" style="zoom:50%;" />

### 4.文件目录：

#### （1）文件控制块FCB：基本信息、存取控制信息、使用信息

#### （2）<font color=red>索引结点的引入</font>（P251；PIC47-48）

#### （3）结构类型：单级文件目录（P252）；两级文件目录（P252）；树形文件目录（P254）

#### （4）<font color=red>若目录文件占用盘块数为N，则查找一个目录项平均需要启动磁盘(N+1)/2次</font>

<img src="./../AppData/Roaming/Typora/typora-user-images/image-20230611220144215.png" alt="image-20230611220144215" style="zoom:50%;" />

### 5.文件的物理结构（P230）

#### （1）格式化：就是将一个文件存储介质，分成许多大小相等的单位——存储块（物理盘块）的过程，在现代计算机系统中，一般来说，每个物理块是一个磁盘的扇区，512字节。并给每个存储块有个编号，称为物理块号。

#### （2）磁盘访问时间

##### 1...寻道时间：把磁头移动到指定磁道上的时间，<font color=red>T1 = m * n + s</font>，其中m为一个常数与磁盘驱动速度有关，s为启动磁臂的时间，n为磁头移动的磁道数

##### 2...旋转延迟时间：将指定扇区移动到磁头下的时间，<font color=red>T2 = 1 / (2 * r)</font>，其中r为磁盘转速

##### 3...传输时间：把数据从磁盘读出或写入磁盘的时间，<font color=red>T3 = b / (r * N)</font>，其中b为每次读写的字节数，N为一条磁道上的字节数

#### （3）<font color=red>磁盘调度算法</font>：先来先服务FCFS；最短寻道时间优先SSTF；扫描SCAN；循环扫描CSCAN；NStepSCAN；FSCAN（P233；PIC49）

#### （4）<font color=red>外存分配方法</font>：连续分配（P268）；链接分配（P270）；索引分配（P276）；混合分配（P277）

<img src="./../AppData/Roaming/Typora/typora-user-images/image-20230612202421582.png" alt="image-20230612202421582" style="zoom: 50%;" />

#### （5）外碎片的处理（PIC50）；

#### （6）FAT占用空间的计算（PIC51-53）

#### （7）空闲存储空间的管理：空闲表法；空闲链表法；位示图法（P280；PIC54-55）；成组链接法（P281）

## 五、设备管理

### 1.设备分类

<img src="./../AppData/Roaming/Typora/typora-user-images/image-20230612214834760.png" alt="image-20230612214834760" style="zoom:50%;" />

<img src="./../AppData/Roaming/Typora/typora-user-images/image-20230612214844148.png" alt="image-20230612214844148" style="zoom:50%;" />

### 2.设备管理功能

<img src="./../AppData/Roaming/Typora/typora-user-images/image-20230612222247705.png" alt="image-20230612222247705" style="zoom:50%;" />

### 3.设备控制器（P197）；通道（P200）；总线；“瓶颈”现象（P202）

### 4.I/O控制方式：轮询（P209）；中断（P209）；直接存储器DMA（P210）；通道（P212）

<img src="./../AppData/Roaming/Typora/typora-user-images/image-20230613102502481.png" alt="image-20230613102502481" style="zoom:50%;" />

<img src="./../AppData/Roaming/Typora/typora-user-images/image-20230613103007911.png" alt="image-20230613103007911" style="zoom:50%;" />

<img src="./../AppData/Roaming/Typora/typora-user-images/image-20230613103159036.png" alt="image-20230613103159036" style="zoom:50%;" />

### 5.I/O软件的层次结构（P193）

### 6.设备分配

#### （1）数据结构：系统设备SDT；设备控制表DCT；控制器控制表COCT；通道控制表CHCT

<img src="./../AppData/Roaming/Typora/typora-user-images/image-20230613104956282.png" alt="image-20230613104956282" style="zoom:50%;" />

### 7.设备独立性

#### （1）逻辑设备表LUT（P218）：完成逻辑设备名到物理设备的映射

#### （2）程序独立性软件

<img src="./../AppData/Roaming/Typora/typora-user-images/image-20230613111812057.png" alt="image-20230613111812057" style="zoom:50%;" />

### 8.<font color=red>虚拟设备管理</font>：假脱机技术Spooling，可将一台物理I/O设备虚拟为多台逻辑I/O设备，这样就允许多用户共享一台物理I/O设备

#### （1）基础：通道技术和多道程序技术

#### （2）主要部分：输入井、输出井；输入缓冲区、输出缓冲区；输入进程、输出进程；井管理程序

### 9.缓冲管理

#### （1）缓冲的引入（P224）

#### （2）缓冲的组织形式：单缓冲（P225；PIC59）；双缓冲（P226；C>T时：PIC60；PIC61）；循环缓冲（P227）；缓冲池（P228）

```c++
//缓冲池同步问题
//Addbuf(type, number)将number指示的缓冲区B挂在type队列上
//Takebuf(type)从type指示的队列的队首摘下一个缓冲区
//资源信号量RS(type), 互斥信号量MS(type)
void Getbuf(type)
{
    Wait(RS(type));
    Wait(MS(type));
    B(number) = Takebuf(type);
    Signal(MS(type));
}
void Putbut(type, number)
{
    Wait(MS(type));
    Addbuf(type, number);
    Signal(MS(type));
    Signal(RS(type));
}
```

